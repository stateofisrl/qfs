{% extends 'base.html' %}

{% block title %}Support - QUANTUM FINANCIAL SYSTEM{% endblock %}

{% block content %}
<div class="space-y-8 px-4 md:px-0">
    <!-- Back Button (Mobile) -->
    <div class="md:hidden mb-4">
        <a href="/settings/" class="flex items-center text-blue-600 hover:text-blue-700 font-semibold transition">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
            </svg>
            Back to Settings
        </a>
    </div>

    <h1 class="text-4xl md:text-5xl font-bold text-gray-900">Support Tickets</h1>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
        <!-- Create Ticket Form -->
        <div class="bg-white rounded-lg shadow-2xl p-6 border border-gray-300">
            <h2 class="text-2xl font-bold text-gray-900 mb-6">Create Ticket</h2>
            <form id="ticket-form" class="space-y-4">
                {% csrf_token %}
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Subject</label>
                    <input type="text" id="subject" required class="w-full px-4 py-3 bg-white border border-gray-300 text-gray-900 rounded-lg focus:ring-2 focus:ring-blue-600 placeholder-gray-500 transition">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Priority</label>
                    <select id="priority" class="w-full px-4 py-3 bg-white border border-gray-300 text-gray-900 rounded-lg focus:ring-2 focus:ring-blue-600 transition">
                        <option value="low">Low</option>
                        <option value="medium" selected>Medium</option>
                        <option value="high">High</option>
                        <option value="urgent">Urgent</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Message</label>
                    <textarea id="message" rows="4" required class="w-full px-4 py-3 bg-white border border-gray-300 text-gray-900 rounded-lg focus:ring-2 focus:ring-blue-600 placeholder-gray-500 transition"></textarea>
                </div>
                
                <button type="submit" class="w-full bg-white hover:bg-blue-700 text-black font-bold py-3 px-4 rounded-lg transition">
                    Send Ticket
                </button>
            </form>
        </div>

        <!-- Tickets List -->
        <div class="bg-white rounded-lg shadow-2xl p-6 border border-gray-300">
            <h2 class="text-2xl font-bold text-gray-900 mb-6">Your Tickets</h2>
            <div id="tickets-list" class="space-y-3">
                <p class="text-gray-600 text-center py-8">No support tickets yet</p>
            </div>
        </div>
    </div>
</div>

<!-- Ticket Details Modal -->
<div id="ticket-modal" class="hidden fixed inset-0 bg-white bg-opacity-50 flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-lg shadow-2xl border border-gray-300 w-full max-w-2xl max-h-[90vh] flex flex-col">
        <!-- Modal Header -->
        <div class="p-6 border-b border-gray-300 flex justify-between items-center">
            <h3 id="modal-subject" class="text-2xl font-bold text-gray-900"></h3>
            <button onclick="closeTicketModal()" class="text-gray-600 hover:text-gray-900 text-2xl">&times;</button>
        </div>
        
        <!-- Modal Body (scrollable) -->
        <div id="ticket-details" class="p-6 overflow-y-auto flex-1">
            <div class="space-y-4">
                <div>
                    <p class="text-sm text-gray-600">Status</p>
                    <span id="modal-status" class="text-xs font-bold px-2 py-1 rounded-full">Status</span>
                </div>
                <div>
                    <p class="text-sm text-gray-600">Priority</p>
                    <span id="modal-priority" class="text-xs font-bold px-2 py-1 rounded-full">Priority</span>
                </div>
                <div>
                    <p class="text-sm text-gray-600">Created</p>
                    <p id="modal-created" class="text-gray-900"></p>
                </div>
                <div>
                    <p class="text-sm text-gray-600 mb-2">Message</p>
                    <p id="modal-message" class="text-gray-700 bg-white p-3 rounded border border-gray-300"></p>
                </div>
                
                <!-- Replies Section -->
                <div class="mt-6 border-t border-gray-300 pt-6">
                    <h4 class="text-lg font-bold text-gray-900 mb-4">Replies</h4>
                    <div id="modal-replies" class="space-y-3">
                        <p class="text-gray-600 text-center py-4">No replies yet</p>
                    </div>
                </div>
                
                <!-- Reply Form -->
                <div class="mt-6 border-t border-gray-300 pt-6">
                    <h4 class="text-lg font-bold text-gray-900 mb-4">Send Reply</h4>
                    <form id="reply-form" class="space-y-3" onsubmit="submitReply(event)">
                        <input type="hidden" id="ticket-id-input" value="">
                        <textarea id="reply-message" rows="3" placeholder="Type your reply..." class="w-full px-4 py-3 bg-white border border-gray-300 text-gray-900 rounded-lg focus:ring-2 focus:ring-blue-600 placeholder-gray-500 transition" required></textarea>
                        <button type="submit" class="w-full bg-white hover:bg-blue-700 text-black font-bold py-2 px-4 rounded-lg transition">
                            Send Reply
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.getElementById('ticket-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const subject = document.getElementById('subject').value;
    const message = document.getElementById('message').value;
    const priority = document.getElementById('priority').value;
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    
    try {
        const response = await fetch('/api/support/tickets/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken,
            },
            body: JSON.stringify({
                subject: subject,
                message: message,
                priority: priority
            })
        });
        
        if (response.ok) {
            document.getElementById('subject').value = '';
            document.getElementById('message').value = '';
            document.getElementById('priority').value = 'medium';
            alert('Ticket created successfully!');
            loadTickets();
        } else {
            const error = await response.json();
            console.error('Error response:', error);
            alert('Error creating ticket: ' + JSON.stringify(error));
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error creating ticket: ' + error.message);
    }
});

function loadTickets() {
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    fetch('/api/support/tickets/', {
        headers: {
            'X-CSRFToken': csrfToken,
        }
    })
    .then(res => res.json())
    .then(data => {
        const list = document.getElementById('tickets-list');
        // Handle both array and paginated response
        const tickets = Array.isArray(data) ? data : (data.results || []);
        if (tickets.length === 0) {
            list.innerHTML = '<p class="text-gray-600 text-center py-8">No support tickets yet</p>';
        } else {
            list.innerHTML = tickets.map(ticket => `
                <div class="bg-white border border-gray-300 rounded-lg p-4 hover:bg-gray-100 transition cursor-pointer" onclick="viewTicketDetails(${ticket.id})">
                    <div class="flex justify-between items-start mb-2">
                        <h4 class="font-bold text-gray-900">${ticket.subject}</h4>
                        <span class="text-xs font-bold px-2 py-1 rounded-full ${getPriorityColor(ticket.priority)}">
                            ${ticket.priority}
                        </span>
                    </div>
                    <p class="text-gray-600 text-sm">${ticket.message}</p>
                    <div class="mt-2 flex justify-between items-center text-xs text-gray-700">
                        <span>${new Date(ticket.created_at).toLocaleDateString()}</span>
                        <span class="capitalize">${ticket.status}</span>
                    </div>
                </div>
            `).join('');
        }
    })
    .catch(error => {
        console.error('Error loading tickets:', error);
        const list = document.getElementById('tickets-list');
        list.innerHTML = '<p class="text-red-800 text-center py-8">Error loading tickets</p>';
    });
}

function viewTicketDetails(ticketId) {
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    fetch(`/api/support/tickets/${ticketId}/`, {
        headers: {
            'X-CSRFToken': csrfToken,
        }
    })
    .then(res => res.json())
    .then(ticket => {
        // Set modal header
        document.getElementById('modal-subject').textContent = ticket.subject;
        document.getElementById('modal-status').textContent = ticket.status.toUpperCase();
        document.getElementById('modal-status').className = `text-xs font-bold px-2 py-1 rounded-full ${getStatusColor(ticket.status)}`;
        document.getElementById('modal-priority').textContent = ticket.priority.toUpperCase();
        document.getElementById('modal-priority').className = `text-xs font-bold px-2 py-1 rounded-full ${getPriorityColor(ticket.priority)}`;
        document.getElementById('modal-created').textContent = new Date(ticket.created_at).toLocaleString();
        document.getElementById('modal-message').textContent = ticket.message;
        document.getElementById('ticket-id-input').value = ticketId;
        
        // Set replies
        const repliesContainer = document.getElementById('modal-replies');
        if (ticket.replies && ticket.replies.length > 0) {
            repliesContainer.innerHTML = ticket.replies.map(reply => `
                <div class="bg-white border border-gray-300 rounded-lg p-4">
                    <div class="flex justify-between items-start mb-2">
                        <p class="font-bold text-gray-900">${reply.sender_name || reply.sender_email}</p>
                        <span class="text-xs text-gray-600">${reply.is_from_admin ? 'ADMIN' : 'YOU'}</span>
                    </div>
                    <p class="text-gray-700 text-sm mb-2">${reply.message}</p>
                    <p class="text-xs text-gray-700">${new Date(reply.created_at).toLocaleString()}</p>
                </div>
            `).join('');
        } else {
            repliesContainer.innerHTML = '<p class="text-gray-600 text-center py-4">No replies yet</p>';
        }
        
        // Show modal
        document.getElementById('ticket-modal').classList.remove('hidden');
    })
    .catch(error => {
        console.error('Error loading ticket details:', error);
        alert('Error loading ticket details');
    });
}

function closeTicketModal() {
    document.getElementById('ticket-modal').classList.add('hidden');
}

function submitReply(event) {
    event.preventDefault();
    
    const ticketId = document.getElementById('ticket-id-input').value;
    const message = document.getElementById('reply-message').value;
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    
    if (!message.trim()) {
        alert('Please enter a message');
        return;
    }
    
    fetch(`/api/support/tickets/${ticketId}/add_reply/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken,
        },
        body: JSON.stringify({
            message: message
        })
    })
    .then(res => {
        if (res.ok) {
            document.getElementById('reply-message').value = '';
            alert('Reply sent successfully!');
            // Reload ticket details to show new reply
            viewTicketDetails(ticketId);
        } else {
            return res.json().then(error => {
                console.error('Error response:', error);
                alert('Error sending reply: ' + JSON.stringify(error));
            });
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error sending reply: ' + error.message);
    });
}

function getPriorityColor(priority) {
    const colors = {
        'low': 'bg-blue-100 text-blue-800',
        'medium': 'bg-yellow-100 text-yellow-800',
        'high': 'bg-orange-900 text-orange-400',
        'urgent': 'bg-red-100 text-red-800'
    };
    return colors[priority] || 'bg-gray-100 text-gray-700';
}

function getStatusColor(status) {
    const colors = {
        'open': 'bg-red-100 text-red-800',
        'in_progress': 'bg-yellow-100 text-yellow-800',
        'resolved': 'bg-green-100 text-green-800',
        'closed': 'bg-gray-100 text-gray-700'
    };
    return colors[status] || 'bg-gray-100 text-gray-700';
}

// Close modal when clicking outside
document.getElementById('ticket-modal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeTicketModal();
    }
});

// Load tickets on page load
document.addEventListener('DOMContentLoaded', loadTickets);
</script>
{% endblock %}
